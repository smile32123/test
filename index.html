<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>SCL-90 自测（离线版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <style>
    :root { --fg:#222; --muted:#666; --bg:#fff; --accent:#2563eb; --warn:#b45309; --danger:#b91c1c; --ok:#059669; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Microsoft Yahei",sans-serif; }
    header { padding:16px 16px 8px; border-bottom:1px solid #eee; }
    header h1 { margin:0 0 8px; font-size:18px; }
    header p { margin:4px 0; color:var(--muted); }
    .container { max-width:920px; margin:0 auto; padding:12px 16px 80px; }
    .toolbar { position:sticky; top:0; background:rgba(255,255,255,0.96); backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid #eee; padding:8px 16px; display:flex; gap:12px; align-items:center; z-index:5; }
    .progress { color:var(--muted); font-size:13px; }
    .btn { appearance:none; border:1px solid #ddd; background:#f8fafc; color:#111827; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .error { color:var(--danger); font-size:13px; }
    .notice { padding:10px 12px; border-radius:8px; background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; margin:12px 0; }
    .crisis { padding:12px; border-radius:8px; background:#fef2f2; border:1px solid #fecaca; color:var(--danger); margin:12px 0; }
    .q { padding:12px; border-bottom:1px solid #f1f5f9; }
    .q h3 { margin:0 0 8px; font-size:14px; }
    .opts { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:8px; }
    .opt { border:1px solid #e5e7eb; border-radius:8px; padding:8px; display:flex; align-items:center; gap:8px; cursor:pointer; }
    .opt input { width:16px; height:16px; }
    .legend { display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:12px; }
    .results { margin-top:16px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; }
    .metrics { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 4px; }
    .metric { flex:1 1 160px; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; }
    .metric h4 { margin:0 0 6px; font-size:13px; color:#374151; }
    .metric .val { font-size:18px; font-weight:600; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px; }
    .pill.ok { background:#ecfdf5; color:var(--ok); border:1px solid #a7f3d0; }
    .pill.warn { background:#fffbeb; color:var(--warn); border:1px solid #fde68a; }
    .pill.danger { background:#fef2f2; color:var(--danger); border:1px solid #fecaca; }
    .factor { border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:10px; }
    .factor h4 { margin:0 0 6px; font-size:14px; }
    .factor p { margin:4px 0; }
    footer { padding:16px; color:var(--muted); font-size:12px; border-top:1px solid #eee; }
    @media print {
      .toolbar, .error, .legend, .btn, header p.disclaimer, .q { display:none !important; }
      .results { border:none; }
      body { background:#fff; }
    }
  </style>
</head>
<body>
  <header>
    <h1>SCL‑90 自测（单页离线版）</h1>
    <p>说明：过去一周内，以下问题给你带来的困扰程度如何？请选择最符合的一项。</p>
    <p class="disclaimer">免责声明：本工具仅用于自评与科普，不构成诊断或治疗建议。如遇紧急风险，请立即联系当地紧急服务或专业机构。</p>
  </header>

  <div class="toolbar">
    <div class="progress" id="progress">已答 0/90</div>
    <div class="legend">1=没有 · 2=很轻 · 3=中等 · 4=偏重 · 5=严重</div>
    <div style="flex:1"></div>
    <button class="btn primary" id="submitBtn">提交并查看结果</button>
  </div>

  <div class="container">
    <div id="crisisBox" class="crisis" style="display:none;"></div>
    <div id="errorBox" class="error"></div>
    <form id="form">
      <div id="questions"></div>
    </form>

    <section id="results" class="results" style="display:none;">
      <h3 style="margin:0 0 6px;">测评结果</h3>
      <div id="resultsSummary" class="metrics"></div>
      <div id="factorAnalyses"></div>
      <p style="color:var(--muted); font-size:12px; margin-top:8px;">
        参考提示：一般而言，因子均分 ≥ 2.0 提示需要关注，≥ 3.0 提示明显困扰。请结合你的实际情境理解结果。
      </p>
    </section>
  </div>

  <footer>
    <div>隐私：本页面不联网、不保存到云端；所有计算在本地浏览器完成。</div>
    <div>求助：如出现自伤/他伤念头或极端困扰，请立即联系家人朋友、当地紧急服务、或专业心理援助热线。</div>
  </footer>

  <script>
    // ---- 配置区：题目与因子映射 ----
    const NUM_ITEMS = 90;

    // 题干占位（可后续替换为正式中文条目）
    const questions = Array.from({length: NUM_ITEMS}, (_,i) => `项目 ${i+1}`);

    // 9个因子映射（1基索引）
    const FACTORS = {
      som:  [1,4,12,27,40,42,48,49,52,53,56,58],                                  // 躯体化
      oc:   [3,9,10,28,38,45,46,51,55,65],                                         // 强迫症状
      is:   [6,21,34,36,37,41,61,69,73],                                           // 人际敏感
      dep:  [5,14,15,20,22,26,29,30,31,32,54,71,79],                               // 抑郁
      anx:  [2,17,23,33,39,57,72,78,80,86],                                        // 焦虑
      hos:  [11,24,63,67,74,81],                                                   // 敌对
      phob: [13,25,47,50,70,75,82],                                                // 恐怖焦虑
      par:  [8,18,43,68,76,83],                                                    // 偏执
      psy:  [7,16,35,62,77,84,85,87,88,90],                                        // 精神病性
    };

    const FACTOR_NAMES = {
      som: '躯体化', oc: '强迫症状', is: '人际敏感', dep: '抑郁',
      anx: '焦虑', hos: '敌对', phob: '恐怖焦虑', par: '偏执', psy: '精神病性'
    };

    // 维度分析文案（按等级拼接）
    function factorAdvice(factorId, level) {
      const base = {
        som:  '关注身体不适与压力关系，如头痛、胸闷、消化不适等；先排除躯体疾病，再考虑放松与睡眠管理。',
        oc:   '可能存在反复思考、难以放松或完美要求；尝试任务分解、限时思考、暴露-反应预防类练习。',
        is:   '在人际互动中更易自责或敏感；练习基于事实的反馈、逐步增加正向互动与自我接纳。',
        dep:  '情绪低落、兴趣减退或动力不足；建立稳定作息、小步行动，必要时寻求专业评估。',
        anx:  '紧张不安、易惊或担忧过多；练习腹式呼吸、渐进性肌肉放松，区分可控与不可控问题。',
        hos:  '易怒或与他人冲突；识别触发情境，练习非暴力沟通与情绪暂离（time-out）。',
        phob: '回避某些场景（如乘坐、密闭、高处等）；可循序渐进进行暴露练习，记录焦虑曲线。',
        par:  '可能较多疑或感受被误解；用证据检验想法，区分猜测与事实，适度求证。',
        psy:  '或伴思维怪异感、社交退缩或现实感降低；若持续且影响功能，建议尽快专业评估。'
      };
      if (level === 'low')  return '总体处于可接受范围。保持当下策略与规律生活。';
      if (level === 'mid')  return '提示一定困扰：' + base[factorId];
      if (level === 'high') return '提示明显困扰，建议尽快寻求专业评估与支持：' + base[factorId];
      return '';
    }

    // 计算等级与标签
    function levelFromMean(m) {
      if (m >= 3) return {k:'high', label:'明显困扰', cls:'danger'};
      if (m >= 2) return {k:'mid',  label:'需要关注', cls:'warn'};
      return {k:'low', label:'总体可接受', cls:'ok'};
    }

    // ---- 渲染题目 ----
    const qWrap = document.getElementById('questions');
    const form = document.getElementById('form');
    const progressEl = document.getElementById('progress');
    const errorBox = document.getElementById('errorBox');
    const submitBtn = document.getElementById('submitBtn');

    function renderQuestions() {
      const frag = document.createDocumentFragment();
      for (let i=1;i<=NUM_ITEMS;i++) {
        const qDiv = document.createElement('div');
        qDiv.className = 'q';
        qDiv.id = 'q' + i;
        const title = document.createElement('h3');
        title.textContent = `${i}. ${questions[i-1]}`;
        qDiv.appendChild(title);

        const opts = document.createElement('div');
        opts.className = 'opts';
        const labels = ['没有','很轻','中等','偏重','严重'];
        for (let v=1; v<=5; v++) {
          const lab = document.createElement('label');
          lab.className = 'opt';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'q' + i;
          input.value = String(v);
          lab.appendChild(input);
          const span = document.createElement('span');
          span.textContent = `${v}（${labels[v-1]}）`;
          lab.appendChild(span);
          opts.appendChild(lab);
        }
        qDiv.appendChild(opts);
        frag.appendChild(qDiv);
      }
      qWrap.appendChild(frag);
    }
    renderQuestions();

    // ---- 进度统计 ----
    function updateProgress() {
      const answered = Array.from({length:NUM_ITEMS},(_,i)=>document.querySelector(`input[name="q${i+1}"]:checked`)).filter(Boolean).length;
      progressEl.textContent = `已答 ${answered}/${NUM_ITEMS}`;
    }
    form.addEventListener('change', updateProgress);
    updateProgress();

    // ---- 提交、校验与计分 ----
    function scrollToQuestion(i) {
      const el = document.getElementById('q'+i);
      if (el) el.scrollIntoView({behavior:'smooth', block:'center'});
    }

    function compute() {
      // 校验
      errorBox.textContent = '';
      for (let i=1;i<=NUM_ITEMS;i++) {
        const chosen = document.querySelector(`input[name="q${i}"]:checked`);
        if (!chosen) {
          errorBox.textContent = `还有未作答的题目：第 ${i} 题`;
          scrollToQuestion(i);
          return null;
        }
      }
      // 汇总
      const vals = [0]; // 1基
      let total = 0, pst = 0;
      for (let i=1;i<=NUM_ITEMS;i++) {
        const v = parseInt(document.querySelector(`input[name="q${i}"]:checked`).value,10);
        vals[i] = v;
        total += v;
        if (v >= 2) pst++;
      }
      // 维度
      const factorMeans = {};
      for (const k of Object.keys(FACTORS)) {
        const ids = FACTORS[k];
        const sum = ids.reduce((acc,idx)=>acc+vals[idx],0);
        factorMeans[k] = sum / ids.length;
      }
      const gsi = total / NUM_ITEMS;
      const psdi = pst ? (total / pst) : 0;

      // 危机提示：第15题（自伤/绝望相关）≥4 给出提醒（也可扩展更多触发项）
      const crisis = (vals[15] >= 4);
      return {factorMeans, gsi, pst, psdi, crisis};
    }

    // ---- 展示结果与维度分析 ----
    const resultsEl = document.getElementById('results');
    const resultsSummary = document.getElementById('resultsSummary');
    const factorAnalyses = document.getElementById('factorAnalyses');
    const crisisBox = document.getElementById('crisisBox');

    function showResults(res) {
      // 危机提示
      crisisBox.style.display = res.crisis ? 'block' : 'none';
      crisisBox.textContent = res.crisis
        ? '重要提示：你的部分作答提示存在较高风险。如出现自伤/他伤或强烈绝望感，请立即联系当地紧急服务或专业机构寻求帮助。'
        : '';

      // 关键指标
      resultsSummary.innerHTML = '';
      const mk = (title,val,desc) => {
        const box = document.createElement('div');
        box.className = 'metric';
        const h4 = document.createElement('h4'); h4.textContent = title; box.appendChild(h4);
        const v = document.createElement('div'); v.className='val'; v.textContent = val; box.appendChild(v);
        if (desc) { const d = document.createElement('div'); d.style.color='var(--muted)'; d.style.fontSize='12px'; d.textContent = desc; box.appendChild(d); }
        return box;
      };
      resultsSummary.appendChild(mk('总均分 GSI', res.gsi.toFixed(2), '整体症状负担'));
      resultsSummary.appendChild(mk('阳性项目数 PST', String(res.pst), '得分≥2的题目数量'));
      resultsSummary.appendChild(mk('阳性平均 PSDI', res.psdi.toFixed(2), '阳性题目的平均强度'));

      // 维度分析
      factorAnalyses.innerHTML = '';
      for (const k of Object.keys(FACTORS)) {
        const mean = res.factorMeans[k];
        const lvl = levelFromMean(mean);
        const section = document.createElement('div');
        section.className = 'factor';
        const h4 = document.createElement('h4');
        h4.innerHTML = `${FACTOR_NAMES[k]}：${mean.toFixed(2)} <span class="pill ${lvl.cls}">${lvl.label}</span>`;
        section.appendChild(h4);
        const p1 = document.createElement('p');
        p1.textContent = (() => {
          if (lvl.k === 'low')  return '解读：当前该维度总体处于可接受范围，偶发体验属于常见现象。';
          if (lvl.k === 'mid')  return '解读：该维度存在一定程度的困扰，建议留意触发情境与持续时间。';
          return '解读：该维度提示明显困扰，可能已影响学习/工作/关系或生理状态。';
        })();
        const p2 = document.createElement('p');
        p2.textContent = '建议：' + factorAdvice(k, lvl.k);
        section.appendChild(p1);
        section.appendChild(p2);
        factorAnalyses.appendChild(section);
      }

      resultsEl.style.display = 'block';
      resultsEl.scrollIntoView({behavior:'smooth', block:'start'});
    }

    submitBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const res = compute();
      if (!res) return;
      showResults(res);
    });
  </script>
</body>
</html>
